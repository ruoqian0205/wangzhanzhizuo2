<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFED - Ozone-depleting Substances & Fluorinated gases Emissions Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .nav-link.active { border-bottom: 2px solid white; font-weight: bold; }
        .method-box { transition: all 0.3s ease; }
        .method-box:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen font-sans">

    <nav class="bg-blue-900 text-white sticky top-0 z-50 shadow-md">
        <div class="container mx-auto px-4 flex justify-between items-center h-16">
            <div class="flex items-center space-x-2">
                <span class="text-2xl font-bold tracking-tighter cursor-pointer" onclick="showPage('home')">OFED</span>
            </div>
            <div class="hidden lg:flex space-x-6 text-sm uppercase tracking-wide">
                <button onclick="showPage('home')" id="nav-home" class="nav-link py-2 hover:text-blue-300 transition">Database Introduction</button>
                <button onclick="showPage('inventory')" id="nav-inventory" class="nav-link py-2 hover:text-blue-300 transition">Inventory Emission</button>
                <button onclick="showPage('inversion')" id="nav-inversion" class="nav-link py-2 hover:text-blue-300 transition">Inversion Emission</button>
                <button onclick="showPage('comparison')" id="nav-comparison" class="nav-link py-2 hover:text-blue-300 transition">OFED and Other datasets</button>
                <button onclick="showPage('about')" id="nav-about" class="nav-link py-2 hover:text-blue-300 transition">About Team</button>
            </div>
            <div id="user-status">
                <button onclick="openAuthModal()" class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded shadow text-sm font-semibold transition">
                    Login / Sign up
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow">
        <section id="home" class="page active">
            <div class="bg-blue-50 py-16 border-b border-blue-100 text-center px-4">
                <h1 class="text-4xl md:text-5xl font-extrabold text-blue-900 mb-6 max-w-5xl mx-auto">OFED: Ozone-depleting Substances & Fluorinated Gases Emissions Database</h1>
                <p class="text-xl text-gray-700 max-w-4xl mx-auto leading-relaxed">
                    The OFED platform provides authoritative and transparent emissions data for ozone-depleting substances (ODS) and fluorinated greenhouse gases (F-gases). These compounds represent a dual challenge: they threaten the recovery of the stratospheric ozone layer and are potent drivers of climate change.
                </p>
            </div>
            <div class="container mx-auto px-4 py-16">
                <div class="grid md:grid-cols-2 gap-12 mb-16">
                    <div class="bg-white p-8 rounded-xl border-l-4 border-blue-600 shadow-sm">
                        <h2 class="text-2xl font-bold text-blue-900 mb-4">The Montreal Protocol</h2>
                        <p class="text-gray-600">Successfully phased out most ODS, safeguarding the stratospheric ozone layer for future generations.</p>
                    </div>
                    <div class="bg-white p-8 rounded-xl border-l-4 border-green-600 shadow-sm">
                        <h2 class="text-2xl font-bold text-green-900 mb-4">UN Climate Change Conventions</h2>
                        <p class="text-gray-600">Mandate the reduction of all greenhouse gases, including many F-gases and remaining ODS, to mitigate global warming.</p>
                    </div>
                </div>
                <div class="prose max-w-none text-gray-700 space-y-6">
                    <p>Accurate quantification of emissions is essential. It transforms invisible releases into actionable insights, enabling scientists and policymakers to track progress, identify sources, verify compliance, and forecast environmental outcomes.</p>
                    <p>OFED serves as a vital bridge between scientific measurement, effective policy, and planetary health. We consolidate disparate data—from atmospheric observations to industrial reporting—into a trusted, open-access resource to support a sustainable future.</p>
                    <div class="text-center pt-8">
                        <span class="text-2xl font-serif italic text-blue-800">"Data for Action. Science for Protection."</span>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-8 mt-16">
                    <div class="method-box bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer" onclick="showPage('inventory')">
                        <span class="text-blue-600 font-bold uppercase tracking-widest text-sm">Explore Results</span>
                        <h3 class="text-2xl font-bold mt-2 mb-4">Bottom-up Inventory Method</h3>
                        <p class="text-gray-500 mb-4">Detailed accounting based on activity data and emission factors across industrial sectors.</p>
                        <span class="text-blue-600 font-semibold inline-flex items-center">View Database &rarr;</span>
                    </div>
                    <div class="method-box bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer" onclick="showPage('inversion')">
                        <span class="text-green-600 font-bold uppercase tracking-widest text-sm">Explore Results</span>
                        <h3 class="text-2xl font-bold mt-2 mb-4">Top-down Inversion Method</h3>
                        <p class="text-gray-500 mb-4">Independent assessment based on global atmospheric observations and transport models.</p>
                        <span class="text-green-600 font-semibold inline-flex items-center">View Database &rarr;</span>
                    </div>
                </div>
            </div>
        </section>

        <section id="inventory" class="page container mx-auto px-4 py-12">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-8">
                <div class="flex justify-between items-end mb-6 border-b pb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-blue-900">Inventory Emission Visualization</h2>
                        <p class="text-gray-500 text-sm">Visualize trends and download raw activity data.</p>
                    </div>
                    <button onclick="handleDownload('inventory.csv')" class="flex items-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        <span>Download Excel</span>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Substance</label>
                        <select id="substance-select" onchange="updateInventoryChart('line')" class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <option>CFC-11</option><option>CFC-12</option><option>HCFC-22</option>
                            <option>HCFC-141b</option><option>HCFC-142b</option><option>HFC-134a</option>
                            <option>HFC-143a</option><option>HFC-32</option><option>HFC-125</option><option>HFC-152a</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Start Year</label><select id="start-year" class="w-full border rounded-lg p-2 text-sm"></select></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">End Year</label><select id="end-year" class="w-full border rounded-lg p-2 text-sm"></select></div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Region</label>
                        <select id="region-select" class="w-full border rounded-lg p-2 text-sm">
                            <option>China</option><option>USA</option><option>EU-27</option><option>India</option><option>Japan</option><option>Global</option>
                        </select>
                    </div>
                    <div class="flex items-end space-x-2">
                        <button onclick="updateInventoryChart('line')" class="flex-1 bg-blue-900 text-white text-xs font-bold py-2.5 rounded hover:bg-black transition uppercase">Total (Line)</button>
                        <button onclick="updateInventoryChart('bar')" class="flex-1 bg-gray-200 text-gray-800 text-xs font-bold py-2.5 rounded hover:bg-gray-300 transition uppercase">Sector (Bar)</button>
                    </div>
                </div>
                <div id="inventory-chart" class="w-full h-[500px]"></div>
            </div>
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8">
                <h3 class="text-2xl font-bold text-gray-900 mb-4 border-l-4 border-blue-600 pl-4">Bottom-up Inventory Method</h3>
                <p class="text-gray-600 leading-relaxed italic">
                    The bottom-up inventory method is an accounting approach based on detailed activity data and emission factors. It systematically collects activity-level information (such as production output, consumption volume, and equipment stocks) from various emission sources. This data is then multiplied by scientifically determined specific emission factors to calculate the total emissions.
                </p>
            </div>
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-xl font-bold text-gray-900 mb-6">Relevant Publications</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-4 font-bold">Substance</th><th class="p-4 font-bold">Year Range</th><th class="p-4 font-bold">Region</th><th class="p-4 font-bold">Reference</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr><td class="p-4">CFC-11</td><td class="p-4">1980-2024</td><td class="p-4">China</td><td class="p-4 text-blue-600 underline">Research Group et al. (2024), Nature Communications</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="inversion" class="page container mx-auto px-4 py-12">
            <div class="bg-white p-6 rounded-xl shadow mb-10">
                <div class="flex justify-between mb-4 border-b pb-3">
                    <div>
                        <h2 class="text-2xl font-bold text-green-900">Inversion Emission</h2>
                        <p class="text-sm text-gray-500">Top-down estimations with uncertainty ranges (Mean ± SD)</p>
                    </div>
                    <button onclick="handleDownload('inversion.csv')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        Download Excel
                    </button>
                </div>
                <div class="grid md:grid-cols-5 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Substance</label>
                        <select id="inv-substance" class="w-full border p-2 rounded text-sm">
                            <option>HCFC-22</option><option>HCFC-141b</option><option>HCFC-142b</option><option>CFC-11</option><option>CFC-12</option>
                            <option>HFC-134a</option><option>HFC-143a</option><option>HFC-32</option><option>HFC-125</option><option>HFC-152a</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Start Year</label><select id="inv-start-year" class="w-full border p-2 rounded text-sm"></select></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">End Year</label><select id="inv-end-year" class="w-full border p-2 rounded text-sm"></select></div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Region</label>
                        <select id="inv-country" class="w-full border p-2 rounded text-sm">
                            <option>China</option><option>USA</option><option>EU-27</option><option>India</option><option>Japan</option><option>Global</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="renderInversionChart()" class="w-full bg-green-700 text-white font-bold py-2 rounded hover:bg-green-800 transition uppercase text-xs h-[38px]">
                            Update Chart
                        </button>
                    </div>
                </div>
                <div id="inversion-chart" class="w-full h-[520px]"></div>
            </div>
             <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8">
                <h3 class="text-2xl font-bold text-gray-900 mb-4 border-l-4 border-green-600 pl-4">Methodology: Top-down Inversion</h3>
                <p class="text-gray-600 leading-relaxed italic">
                    The top-down inversion method is an independent assessment method based on atmospheric observations. It involves directly measuring the concentrations of target gases in the atmosphere via ground-based stations and satellites.
                </p>
            </div>
        </section>

        <section id="comparison" class="page container mx-auto px-4 py-12">
            <div class="bg-white p-6 rounded-xl shadow mb-10">
                <div class="flex justify-between mb-4 border-b pb-3">
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-900">OFED & Other Datasets</h2>
                        <p class="text-sm text-gray-500">Comparison of Bottom-up inventories and Top-down (Inverse Modeling & ISC) estimates.</p>
                    </div>
                    <button onclick="handleDownload('comparison.csv')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
                        Download Data
                    </button>
                </div>
                <div class="grid md:grid-cols-5 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Region</label>
                        <select id="comp-region" class="w-full border p-2 rounded text-sm">
                            <option>China</option><option>USA</option><option>EU-27</option><option>India</option><option>Japan</option><option>Global</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Substance</label>
                        <select id="comp-substance" class="w-full border p-2 rounded text-sm">
                            <option>HCFC-22</option><option>HCFC-141b</option><option>HCFC-142b</option><option>CFC-11</option><option>CFC-12</option>
                            <option>HFC-134a</option><option>HFC-143a</option><option>HFC-32</option><option>HFC-125</option><option>HFC-152a</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Start Year</label><select id="comp-start-year" class="w-full border p-2 rounded text-sm"></select></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">End Year</label><select id="comp-end-year" class="w-full border p-2 rounded text-sm"></select></div>
                    <div class="flex items-end">
                        <button onclick="renderComparisonChart()" class="w-full bg-indigo-700 text-white font-bold py-2 rounded hover:bg-indigo-800 transition uppercase text-xs h-[38px]">
                            Update Comparison
                        </button>
                    </div>
                </div>
                <div id="comparison-chart" class="w-full h-[600px]"></div>
            </div>
            <div class="bg-white p-8 rounded-xl shadow border border-gray-100">
                <h3 class="text-xl font-bold text-gray-900 mb-6 border-l-4 border-indigo-600 pl-4">Publications & Data Sources</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3">Study / Reference</th>
                                <th class="px-6 py-3">Methodology</th>
                                <th class="px-6 py-3">Year Range</th>
                            </tr>
                        </thead>
                        <tbody id="comp-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="about" class="page">
            <div class="bg-blue-50 py-12 border-b border-blue-100 text-center px-4 mb-8">
                <h1 class="text-3xl md:text-4xl font-extrabold text-blue-900 mb-4">Meet the Team</h1>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                    A professional team dedicated to the research of fluorinated greenhouse gas emissions.
                </p>
            </div>
            <div class="container mx-auto px-4 pb-12 max-w-6xl">
                 <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-12">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-l-4 border-blue-600 pl-4">Team Introduction</h2>
                    <p class="text-gray-600 leading-relaxed">
                        Our research team is affiliated with the <strong>Climate Change Research Center</strong>. We rely on national research platforms and integrate multi-source data to establish the OFED database.
                    </p>
                </div>
                <div class="mb-12">
                    <h2 class="text-2xl font-bold text-center text-gray-900 mb-8">Core Members</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition duration-300">
                            <div class="w-24 h-24 bg-blue-100 rounded-full mx-auto mb-6 flex items-center justify-center text-blue-600 text-3xl font-bold">L</div>
                            <h3 class="text-xl font-bold text-gray-900 mb-1">Prof. Ming Li</h3>
                            <p class="text-blue-600 font-medium mb-4">Team Leader</p>
                        </div>
                        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition duration-300">
                            <div class="w-24 h-24 bg-green-100 rounded-full mx-auto mb-6 flex items-center justify-center text-green-600 text-3xl font-bold">W</div>
                            <h3 class="text-xl font-bold text-gray-900 mb-1">Assoc. Prof. Hua Wang</h3>
                            <p class="text-green-600 font-medium mb-4">Head of Data Science</p>
                        </div>
                        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition duration-300">
                            <div class="w-24 h-24 bg-indigo-100 rounded-full mx-auto mb-6 flex items-center justify-center text-indigo-600 text-3xl font-bold">Z</div>
                            <h3 class="text-xl font-bold text-gray-900 mb-1">Dr. Wei Zhang</h3>
                            <p class="text-indigo-600 font-medium mb-4">Senior Researcher</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white w-full max-w-md rounded-xl p-6">
                <h2 class="text-xl font-bold mb-4" id="auth-title">Login</h2>
                <div id="register-fields" class="space-y-2 hidden">
                    <input id="reg-name" class="w-full border p-2 rounded" placeholder="Full Name">
                    <input id="reg-country" class="w-full border p-2 rounded" placeholder="Country">
                </div>
                <input id="auth-email" class="w-full border p-2 rounded mt-2" placeholder="Email">
                <div class="flex justify-between mt-4">
                    <button onclick="submitAuth()" class="bg-blue-600 text-white px-4 py-2 rounded">Submit</button>
                    <button onclick="toggleAuthMode()" class="text-blue-600 text-sm">Switch to Register</button>
                </div>
                <button onclick="closeAuthModal()" class="text-gray-400 text-xs mt-3">Cancel</button>
            </div>
        </div>

    </main>

    <footer class="bg-gray-900 text-gray-400 py-12 border-t border-gray-800">
        <div class="container mx-auto px-4 text-center">
            <p class="text-white mb-2">Ozone-depleting Substances & Fluorinated gases Emissions Database (OFED)</p>
            <p class="text-sm">Contact: <a href="mailto:contact@ofed.com" class="text-blue-400 underline">contact@ofed.com</a></p>
        </div>
    </footer>

    <script>
    let inventoryData = [];
    let inversionData = [];
    let comparisonData = [];
    let isLoggedIn = false;
    let currentInvChartType = 'line';
    let authMode = 'login';

    const yearsRange = Array.from({length: 45}, (_, i) => 1980 + i);

    // 1. Data Loading
    async function loadData() {
        try {
            console.log("Starting to load CSV data...");
            const fetchCSV = async (url) => {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                const csvText = await response.text();
                return new Promise(resolve => {
                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => resolve(results.data)
                    });
                });
            };

            // Ensure these filenames match exactly what you upload to GitHub
            const [inv, invs, comp] = await Promise.all([
                fetchCSV('inventory.csv'),
                fetchCSV('inversion.csv'),
                fetchCSV('comparison.csv')
            ]);

            inventoryData = inv;
            inversionData = invs;
            comparisonData = comp;
            console.log("Data loaded successfully");
            return true;

        } catch (error) {
            console.error("Failed to load data:", error);
            document.body.insertAdjacentHTML('afterbegin', `<div class="bg-red-500 text-white p-4 text-center sticky top-0 z-[60]">Data loading failed: ${error.message}. Please check that inventory.csv, inversion.csv, and comparison.csv exist in the repository.</div>`);
            return false;
        }
    }

    // 2. Initialization
    window.addEventListener("load", async () => {
        // Initialize Dropdowns first
        initSelects();
        initInversionSelect();
        initComparisonSelect();

        // Load Data
        const success = await loadData();

        // If success, render charts
        if (success) {
            updateInventoryChart("line");
            renderInversionChart();
            renderComparisonChart();
        }

        // Show Home Page
        showPage("home");
    });

    window.onresize = function() {
        ['inventory-chart', 'inversion-chart', 'comparison-chart'].forEach(id => {
            const chart = echarts.getInstanceByDom(document.getElementById(id));
            if(chart) chart.resize();
        });
    };

    // 3. Navigation
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');

        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        if(pageId === 'home') document.getElementById('nav-home')?.classList.add('active');
        if(pageId === 'inventory') document.getElementById('nav-inventory')?.classList.add('active');
        if(pageId === 'inversion') document.getElementById('nav-inversion')?.classList.add('active');
        if(pageId === 'comparison') document.getElementById('nav-comparison')?.classList.add('active');
        if(pageId === 'about') document.getElementById('nav-about')?.classList.add('active');

        window.scrollTo(0, 0);

        // Re-render charts when tab switches to ensure correct width
        setTimeout(() => {
            if(pageId === 'inventory') updateInventoryChart(currentInvChartType);
            if(pageId === 'inversion') renderInversionChart();
            if(pageId === 'comparison') renderComparisonChart();
        }, 100);
    }

    // 4. Dropdown Initialization Helpers
    function initSelects() {
        const s = document.getElementById('start-year');
        const e = document.getElementById('end-year');
        fillYears(s, e);
    }
    function initInversionSelect() {
        const s = document.getElementById('inv-start-year');
        const e = document.getElementById('inv-end-year');
        fillYears(s, e);
    }
    function initComparisonSelect() {
        const s = document.getElementById('comp-start-year');
        const e = document.getElementById('comp-end-year');
        fillYears(s, e);
    }
    function fillYears(s, e) {
        if(!s || !e) return;
        s.innerHTML = ''; e.innerHTML = '';
        yearsRange.forEach(y => {
            s.add(new Option(y, y));
            e.add(new Option(y, y));
        });
        s.value = 1980;
        e.value = 2024;
    }

    // 5. Chart Logic - Inventory
    function updateInventoryChart(type) {
        currentInvChartType = type;
        if(inventoryData.length === 0) return;

        const substance = document.getElementById('substance-select').value;
        const region    = document.getElementById('region-select').value;
        const sYear     = parseInt(document.getElementById('start-year').value);
        const eYear     = parseInt(document.getElementById('end-year').value);

        if (sYear > eYear) { alert("Start year cannot be greater than end year"); return; }

        const filtered = inventoryData.filter(d =>
            d.substance === substance && d.region === region && d.year >= sYear && d.year <= eYear
        );

        const chartDom = document.getElementById('inventory-chart');
        const oldChart = echarts.getInstanceByDom(chartDom);
        if (oldChart) oldChart.dispose();
        const chart = echarts.init(chartDom);
        const uniqueYears = [...new Set(filtered.map(d => d.year))].sort((a, b) => a - b);

        let option = {};

        if (type === "line") {
            const totalData = uniqueYears.map(y => {
                // Try to find a row where sector is 'Total' or sum up all sectors if needed.
                // Assuming your CSV has a "Total" sector row:
                const row = filtered.find(d => d.year === y && (d.sector === "Total" || d.sector === "total"));
                return row ? row.value : 0;
            });
            option = {
                title: { text: `${substance} Inventory Emissions (${region})`, left: "center" },
                tooltip: { trigger: "axis" },
                xAxis: { type: "category", data: uniqueYears },
                yAxis: { type: "value", name: "Gg yr⁻¹" },
                series: [{ name: "Total", type: "line", smooth: true, data: totalData, areaStyle: {} }]
            };
        } else {
            const sectors = [...new Set(filtered.map(d => d.sector).filter(s => s !== "Total" && s !== "total"))];
            const series = sectors.map(sec => ({
                name: sec,
                type: "bar",
                stack: "total",
                data: uniqueYears.map(y => {
                    const row = filtered.find(d => d.year === y && d.sector === sec);
                    return row ? row.value : 0;
                })
            }));
            option = {
                title: { text: `${substance} Sectoral Breakdown (${region})`, left: "center" },
                tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
                legend: { bottom: 0 },
                xAxis: { type: "category", data: uniqueYears },
                yAxis: { type: "value", name: "Gg yr⁻¹" },
                series: series
            };
        }
        chart.setOption(option);
    }

    // 6. Chart Logic - Inversion
function renderInversionChart() {

    var chartDom = document.getElementById("inversion-chart");
    if (!chartDom) return;

    var substance = document.getElementById("inv-substance").value;
    var region = document.getElementById("inv-country").value;
    var sYear = parseInt(document.getElementById("inv-start-year").value);
    var eYear = parseInt(document.getElementById("inv-end-year").value);

    if (sYear > eYear) {
        alert("Start year cannot be greater than end year");
        return;
    }

    var filtered = inversionData.filter(function (d) {
        return d.substance === substance &&
               d.region === region &&
               d.year >= sYear &&
               d.year <= eYear;
    });

    var oldChart = echarts.getInstanceByDom(chartDom);
    if (oldChart) oldChart.dispose();
    var chart = echarts.init(chartDom);

    if (filtered.length === 0) {
        chart.clear();
        return;
    }

    var years = [];
    filtered.forEach(function (d) {
        if (years.indexOf(d.year) === -1) years.push(d.year);
    });
    years.sort(function (a, b) { return a - b; });

    var studies = [];
    filtered.forEach(function (d) {
        if (studies.indexOf(d.study) === -1) studies.push(d.study);
    });

    var series = [];
    var allValues = [];

    studies.forEach(function (study) {

        var rows = filtered.filter(function (d) {
            return d.study === study;
        });

        var lineData = [];
        var errorData = [];

        years.forEach(function (y, idx) {
            var r = rows.find(function (d) {
                return d.year === y;
            });

            if (!r) {
                lineData.push(null);
                return;
            }

            // ✅ ES5 安全写法（关键修复）
            var val = (r.mean !== undefined && r.mean !== null)
                ? r.mean
                : r.Mean;

            var sd = (r.sd !== undefined && r.sd !== null)
                ? r.sd
                : r.SD;

            if (val !== undefined && val !== null) {
                lineData.push(val);
                allValues.push(val);

                if (sd !== undefined && sd !== null && !isNaN(sd)) {
                    errorData.push([idx, val - sd, val + sd]);
                    allValues.push(val - sd, val + sd);
                }
            } else {
                lineData.push(null);
            }
        });

        series.push({
            name: study,
            type: "line",
            data: lineData,
            smooth: true,
            symbol: "circle",
            symbolSize: 6
        });

        if (errorData.length > 0) {
            series.push({
                name: study + " error",
                type: "custom",
                tooltip: { show: false },
                renderItem: function (params, api) {

                    var x = api.value(0);
                    var low = api.coord([x, api.value(1)]);
                    var high = api.coord([x, api.value(2)]);
                    var half = 4;

                    var style = api.style({
                        stroke: api.visual('color'),
                        lineWidth: 1.2,
                        fill: null
                    });

                    return {
                        type: 'group',
                        children: [
                            { type: 'line', shape: { x1: high[0], y1: high[1], x2: low[0], y2: low[1] }, style: style },
                            { type: 'line', shape: { x1: high[0]-half, y1: high[1], x2: high[0]+half, y2: high[1] }, style: style },
                            { type: 'line', shape: { x1: low[0]-half, y1: low[1], x2: low[0]+half, y2: low[1] }, style: style }
                        ]
                    };
                },
                data: errorData,
                z: 10
            });
        }
    });

    var yMin = 0, yMax = 100;
    if (allValues.length > 0) {
        yMin = Math.max(0, Math.min.apply(null, allValues) * 0.8);
        yMax = Math.max.apply(null, allValues) * 1.1;
    }

    chart.setOption({
        title: {
            text: substance + " Inversion Emissions (" + region + ")",
            left: "center"
        },
        tooltip: { trigger: "axis" },
        legend: { bottom: 0 },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '12%',
            containLabel: true
        },
        xAxis: {
            type: "category",
            data: years
        },
        yAxis: {
            type: "value",
            name: "Gg yr⁻¹",
            min: yMin,
            max: yMax
        },
        series: series
    });
}



    // 7. Chart Logic - Comparison
    function renderComparisonChart() {
        if(comparisonData.length === 0) return;
        const substance = document.getElementById("comp-substance").value;
        const region    = document.getElementById("comp-region").value;
        const sYear     = parseInt(document.getElementById("comp-start-year").value);
        const eYear     = parseInt(document.getElementById("comp-end-year").value);

        const filtered = comparisonData.filter(d =>
            d.substance === substance && d.region === region && d.year >= sYear && d.year <= eYear
        );

        const uniqueYears = [...new Set(filtered.map(d => d.year))].sort((a,b)=>a-b);
        const datasets = [...new Set(filtered.map(d => d.dataset))];

        const chartDom = document.getElementById("comparison-chart");
        if(echarts.getInstanceByDom(chartDom)) echarts.dispose(chartDom);
        const chart = echarts.init(chartDom);

        let series = [];
        let tableHTML = "";

        datasets.forEach(name => {
            const rows = filtered.filter(d => d.dataset === name);
            const data = uniqueYears.map(y => {
                const r = rows.find(d => d.year === y);
                return r ? r.value : null;
            });
            const method = rows[0]?.method || "Unknown";

            series.push({
                name: name, type: "line", data: data,
                symbol: method.includes("Bottom-up") ? "circle" : "emptyTriangle"
            });

            tableHTML += `<tr><td class="px-6 py-4">${name}</td><td class="px-6 py-4">${method}</td><td class="px-6 py-4">${sYear}-${eYear}</td></tr>`;
        });

        document.getElementById("comp-table-body").innerHTML = tableHTML;
        chart.setOption({
            title: { text: `${substance} Emission Comparison (${region})`, left: "center" },
            tooltip: { trigger: "axis" },
            legend: { bottom: 0 },
            xAxis: { type: "category", data: uniqueYears },
            yAxis: { type: "value", name: "Gg yr⁻¹" },
            series: series
        });
    }

    // 8. Auth & Downloads (Simulated)
    function openAuthModal() { document.getElementById('auth-modal').classList.remove('hidden'); }
    function closeAuthModal() { document.getElementById('auth-modal').classList.add('hidden'); }
    function toggleAuthMode() {
        authMode = authMode === 'login' ? 'register' : 'login';
        document.getElementById('register-fields').classList.toggle('hidden');
        document.getElementById('auth-title').innerText = authMode === 'login' ? 'Login' : 'Register';
    }

    function submitAuth() {
        // GitHub Pages Simulation: Just set true
        isLoggedIn = true;
        const email = document.getElementById('auth-email').value || "user@demo.com";
        document.getElementById('user-status').innerHTML = `<span class="text-sm font-semibold">Welcome, ${email}</span>`;
        closeAuthModal();
        alert("Login Successful (Demo Mode)");
    }

    function handleDownload(filename) {
        if (!isLoggedIn) {
            alert("Please login to download data.");
            openAuthModal();
            return;
        }
        // Direct download from GitHub Pages (static file)
        const link = document.createElement("a");
        link.href = filename; // Points to the file in the same folder
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    </script>
</body>
</html>