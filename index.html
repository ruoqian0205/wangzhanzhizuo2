<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFED - Ozone-depleting Substances & Fluorinated gases Emissions Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .nav-link.active { border-bottom: 2px solid white; font-weight: bold; }
        .method-box { transition: all 0.3s ease; }
        .method-box:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen font-sans">

    <nav class="bg-blue-900 text-white sticky top-0 z-50 shadow-md">
        <div class="container mx-auto px-4 flex justify-between items-center h-16">
            <div class="flex items-center space-x-2">
                <span class="text-2xl font-bold tracking-tighter cursor-pointer" onclick="showPage('home')">OFED</span>
            </div>
            <div class="hidden lg:flex space-x-6 text-sm uppercase tracking-wide">
                <button onclick="showPage('home')" id="nav-home" class="nav-link py-2 hover:text-blue-300 transition">OFED Introduction</button>
                <button onclick="showPage('inventory')" id="nav-inventory" class="nav-link py-2 hover:text-blue-300 transition">OFED Inventory Emissions</button>
                <button onclick="showPage('inversion')" id="nav-inversion" class="nav-link py-2 hover:text-blue-300 transition">OFED Inversion Emissions</button>
                <button onclick="showPage('comparison')" id="nav-comparison" class="nav-link py-2 hover:text-blue-300 transition">OFED and Other Datasets</button>
                <button onclick="showPage('about')" id="nav-about" class="nav-link py-2 hover:text-blue-300 transition">About Team</button>
            </div>
            <div id="user-status">
                <button onclick="openAuthModal()" class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded shadow text-sm font-semibold transition">
                    Login / Sign up
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow">
        <section id="home" class="page active">
            <div class="bg-blue-50 py-6 border-b border-blue-100 text-center px-4">
                <h1 class="text-4xl md:text-5xl font-extrabold text-blue-900 mb-6 max-w-5xl mx-auto">OFED: Ozone-depleting Substances & Fluorinated Gases Emissions Database</h1>
                <p class="text-xl text-gray-700 max-w-4xl mx-auto leading-relaxed">
               The OFED database is derived from the published research findings of 
              <a href="javascript:void(0)" onclick="showPage('about')" class="text-blue-600 hover:text-blue-900 underline-offset-4 transition-colors font-semibold">
                our team
               </a>. 
               </p>
                <p class="text-xl text-gray-700 max-w-4xl mx-auto leading-relaxed">
                    The OFED platform provides authoritative and transparent emissions data for ozone-depleting substances (ODSs) and fluorinated gases (F-gases). These compounds represent a dual challenge: they threaten the recovery of the stratospheric ozone layer and are potent drivers of climate change.
                </p>
            </div>
            <div class="container mx-auto px-4 py-8">
                <div class="grid md:grid-cols-2 gap-12 mb-8">
                    <div class="bg-white p-8 rounded-xl border-l-4 border-blue-600 shadow-sm">
                        <h2 class="text-2xl font-bold text-blue-900 mb-4">The Montreal Protocol</h2>
                        <p class="text-gray-600">Successfully phased out most ODS, safeguarding the stratospheric ozone layer for future generations.</p>
                    </div>
                    <div class="bg-white p-8 rounded-xl border-l-4 border-green-600 shadow-sm">
                        <h2 class="text-2xl font-bold text-green-900 mb-4">UN Climate Change Conventions</h2>
                        <p class="text-gray-600">Mandate the reduction of all greenhouse gases, including many F-gases, to mitigate global warming.</p>
                    </div>
                </div>
                <div class="prose max-w-none text-gray-700 space-y-3 text-center">
                    <p class="text-lg leading-relaxed">
        Accurate quantification of atmospheric emissions is the cornerstone of global environmental governance. 
        It transforms invisible chemical releases into actionable scientific insights, empowering researchers 
        and policymakers to monitor mitigation progress with precision. By mapping the trajectory of these 
        substances, we can identify critical emission hotspots, verify international compliance, and develop 
        robust forecast models for future environmental outcomes.
    </p>
    <p class="text-lg leading-relaxed"> 
        OFED serves as a vital strategic bridge, connecting the rigors of scientific measurement with the 
        demands of effective policy-making for planetary health. We consolidate disparate, multi-source data—ranging 
        from high-frequency atmospheric observations to granular industrial reporting—into a single, trusted, 
        open-access resource.
    </p>
                    <div class="text-center pt-6">
                        <span class="text-2xl font-serif italic text-blue-800">"Data for Action. Science for Protection."</span>
                    </div>
                </div>
                <div class="grid md:grid-cols-3 gap-8 mt-12"> <div class="method-box bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer" onclick="showPage('inventory')">
        <span class="text-blue-600 font-bold uppercase tracking-widest text-sm">Explore Results</span>
        <h3 class="text-2xl font-bold mt-2 mb-4">Inventory Emissions</h3>
        <p class="text-gray-500 mb-4">The bottom-up approach quantifies emissions using activity data (production and consumption) and emission factors.</p>
        <span class="text-blue-600 font-semibold inline-flex items-center">View Database &rarr;</span>
    </div>

    <div class="method-box bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer" onclick="showPage('inversion')">
        <span class="text-green-600 font-bold uppercase tracking-widest text-sm">Explore Results</span>
        <h3 class="text-2xl font-bold mt-2 mb-4">Inversion Emissions</h3>
        <p class="text-gray-500 mb-4">The top-down approach quantifies emissions using observations, transport models, and inversion algorithms.</p>
        <span class="text-green-600 font-semibold inline-flex items-center">View Database &rarr;</span>
    </div>

    <div class="method-box bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer" onclick="showPage('comparison')">
        <span class="text-indigo-600 font-bold uppercase tracking-widest text-sm">Cross-Study Comparison</span>
        <h3 class="text-2xl font-bold mt-2 mb-4">OFED and Other Datasets</h3>
        <p class="text-gray-500 mb-4">Comprehensive comparison between OFED results and other established global/regional emission datasets.</p>
        <span class="text-indigo-600 font-semibold inline-flex items-center">Compare Data &rarr;</span>
    </div>
</div>
            </div>
        </section>

<section id="inventory" class="page container mx-auto px-4 py-12">
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-8">
        <div class="flex justify-between items-end mb-6 border-b pb-4">
            <div>
                <h2 class="text-2xl font-bold text-blue-900">Inventory Emissions Visualization</h2>
                <p class="text-gray-500 text-sm">Provide both total emissions and sectoral breakdowns.</p>
            </div>
            <button onclick="handleDownload('inventory.csv')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                <span>Download Data</span>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Substance</label>
                <select id="substance-select" onchange="handleMainFilterChange()" class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500">
                    <option value="" disabled selected>-- Select Substance --</option><option>CFC-11</option><option>CFC-12</option><option>CFC-113</option><option>CTC</option><option>TCA</option><option>MB</option><option>Halon-1211</option><option>Halon-1301</option><option>HCFC-22</option>
                    <option>HCFC-141b</option><option>HCFC-142b</option><option>HFC-134a</option><option>HFC-143a</option><option>HFC-125</option><option>HFC-32</option><option>HFC-152a</option><option>HFC-245fa</option><option>HFC-227ea</option><option>HFC-236fa</option><option>HFC-365mfc</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Region</label>
                <select id="region-select" onchange="handleMainFilterChange()" class="w-full border rounded-lg p-2 text-sm">
                    <option value="" disabled selected>-- Select Region --</option><option>China</option><option>USA</option><option>Europe</option><option>Japan</option><option>South Korea</option><option>India</option><option>Global</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Start Year</label>
                <select id="start-year" class="w-full border rounded-lg p-2 text-sm"><option>1980</option></select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">End Year</label>
                 <select id="end-year" class="w-full border rounded-lg p-2 text-sm"><option>2024</option></select>
            </div>
            <div id="reference-wrapper">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Source (for Sector)</label>
                <select id="reference-select" class="w-full border rounded-lg p-2 text-sm"></select>
            </div>
            <div class="flex items-end space-x-2">
    <button id="btn-line" onclick="setActiveButton('btn-line'); updateInventoryChart('line')" 
            class="chart-btn flex-1 bg-gray-200 text-gray-800 text-xs font-bold py-2.5 rounded hover:bg-gray-300 transition uppercase">
        Total (Line)
    </button>
    <button id="btn-bar" onclick="setActiveButton('btn-bar'); updateInventoryChart('bar')" 
            class="chart-btn flex-1 bg-gray-200 text-gray-800 text-xs font-bold py-2.5 rounded hover:bg-gray-300 transition uppercase">
        Sector (Bar)
    </button>
</div>
        </div>

        <div id="inventory-chart" class="w-full h-[500px]" style="width: 100%; height: 500px;"></div>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-4 border-l-4 border-blue-600 pl-4">Methodology</h3>
        <p class="text-gray-600 leading-relaxed italic">
            The bottom-up inventory approach estimates emissions based on activity data (production and consumption) and emission factors, in accordance with the emission mechanisms specific to each sector. For detailed methodologies, please refer to the publications listed below.
        </p>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
        <h3 class="text-xl font-bold text-gray-900 mb-6">Publications</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm border-collapse">
                <thead>
                    <tr class="bg-gray-50 border-b">
                        <th class="p-4 font-bold">Study</th>
                        <th class="p-4 font-bold">Substance</th>
                        <th class="p-4 font-bold">Region</th>
                        <th class="p-4 font-bold">Year</th>
                        <th class="p-4 font-bold">Reference</th>
                    </tr>
                </thead>
                <tbody id="publication-table-body" class="divide-y">
                </tbody>
            </table>
        </div>
    </div>
</section>

<section id="inversion" class="page container mx-auto px-4 py-12">
    <div class="bg-white p-6 rounded-xl shadow mb-10">
        
        <div class="flex justify-between mb-4 border-b pb-3">
            <div>
                <h2 class="text-2xl font-bold text-green-900">Inversion Emission</h2>
                <p class="text-sm text-gray-500">Top-down estimations with uncertainty ranges (Mean ± SD)</p>
            </div>
            <button onclick="handleDownload('inversion.csv')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                Download Excel
            </button>
        </div>

        <div class="grid md:grid-cols-5 gap-4 mb-6">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Substance</label>
                <select id="inv-substance" class="w-full border p-2 rounded text-sm">
                    <option>CFC-11</option><option>CFC-12</option>
                    <option>HCFC-22</option><option>HCFC-141b</option><option>HCFC-142b</option>
                    <option>HFC-134a</option><option>HFC-143a</option><option>HFC-32</option>
                    <option>HFC-125</option><option>HFC-152a</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Region</label>
                <select id="inv-country" class="w-full border p-2 rounded text-sm">
                    <option>China</option><option>USA</option><option>Europe</option>
                    <option>India</option><option>Japan</option><option>Global</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Start Year</label>
                <select id="inv-start-year" class="w-full border p-2 rounded text-sm">
                    </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">End Year</label>
                <select id="inv-end-year" class="w-full border p-2 rounded text-sm"></select>
            </div>

            <div class="flex items-end">
                <button onclick="renderInversionChart()" class="w-full bg-green-700 text-white font-bold py-2 rounded hover:bg-green-800 transition uppercase text-xs h-[38px]">
                    Update Chart
                </button>
            </div>
        </div>

        <div id="inversion-chart" class="w-full h-[520px]"></div>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-4 border-l-4 border-green-600 pl-4">Methodology: Top-down Inversion</h3>
        <p class="text-gray-600 leading-relaxed italic">
            The top-down inversion method is an independent assessment method based on atmospheric observations. It involves directly measuring the concentrations of target gases in the atmosphere via ground-based stations and satellites.
        </p>
    </div>

<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mt-8">
    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
        <svg class="w-5 h-5 mr-2 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
        </svg>
        Data References for Current Selection
    </h3>
    <div class="overflow-x-auto bg-white rounded-lg shadow-sm">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Study</th>
                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Substance</th>
                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Region</th>
                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Year</th>
                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Full Citation</th>
                </tr>
            </thead>
            <tbody id="inversion-ref-table" class="divide-y divide-gray-100 text-sm text-gray-700">
                </tbody>
        </table>
    </div>
    <div id="no-ref-msg" class="hidden text-center py-6 text-gray-400 italic">
        No specific reference data found for this selection.
    </div>
</div>

</section>

        <section id="comparison" class="page container mx-auto px-4 py-12">
            <div class="bg-white p-6 rounded-xl shadow mb-10">
                <div class="flex justify-between mb-4 border-b pb-3">
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-900">OFED & Other Datasets</h2>
                        <p class="text-sm text-gray-500">Comparison of Bottom-up inventories and Top-down (Inverse Modeling & ISC) estimates.</p>
                    </div>
                    <button onclick="handleDownload('comparison.csv')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">
                        Download Data
                    </button>
                </div>
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6 items-end">
    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Region</label>
        <select id="comp-region" class="w-full border p-2 rounded text-sm h-[38px] bg-white">
            <option>China</option><option>USA</option><option>EU-27</option>
            <option>India</option><option>Japan</option><option>Global</option>
        </select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Substance</label>
        <select id="comp-substance" class="w-full border p-2 rounded text-sm h-[38px] bg-white">
            <option>HCFC-22</option><option>HCFC-141b</option><option>HCFC-142b</option>
            <option>CFC-11</option><option>CFC-12</option><option>HFC-134a</option>
            <option>HFC-143a</option><option>HFC-32</option><option>HFC-125</option><option>HFC-152a</option>
        </select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Method Category</label>
        <select id="comp-method-filter" class="w-full border p-2 rounded text-sm h-[38px] bg-white">
            <option value="All">All Methods</option>
            <option value="Bottom-up">Bottom-up</option>
            <option value="Top-down">Top-down (Inv/ISC)</option>
        </select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Start Year</label>
        <select id="comp-start-year" class="w-full border p-2 rounded text-sm h-[38px] bg-white"></select>
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">End Year</label>
        <select id="comp-end-year" class="w-full border p-2 rounded text-sm h-[38px] bg-white"></select>
    </div>

    <div>
        <button onclick="renderComparisonChart()" class="w-full bg-indigo-700 text-white font-bold py-2 rounded hover:bg-indigo-800 transition uppercase text-xs h-[38px] flex items-center justify-center">
            Update Comparison
        </button>
    </div>
</div>
                <div id="comparison-chart" class="w-full h-[600px]"></div>
            </div>
            <div class="bg-white p-8 rounded-xl shadow border border-gray-100">
                <h3 class="text-xl font-bold text-gray-900 mb-6 border-l-4 border-indigo-600 pl-4">Publications & Data Sources</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3">Study / Reference</th>
                                <th class="px-6 py-3">Methodology</th>
                                <th class="px-6 py-3">Year Range</th>
                            </tr>
                        </thead>
                        <tbody id="comp-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

<section id="about" class="page">
    <div class="bg-blue-50 py-12 border-b border-blue-100 text-center px-4 mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-900 mb-4">Meet the Team</h1>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
            A professional team dedicated to the research of fluorinated greenhouse gas emissions.
        </p>
    </div>

    <div class="container mx-auto px-4 pb-12 max-w-6xl">
        
        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 border-l-4 border-blue-600 pl-4">Team Introduction</h2>
            <div class="text-gray-600 space-y-4 leading-relaxed">
                <p>
                    The collaboration between Prof. Xuekun Fang, Prof. Jianxin Hu, and Prof. Jing Wu represents a powerful synergy between atmospheric science, environmental policy, and chemical engineering. For over a decade, they have worked together within the framework of the Montreal Protocol, focusing on the rigorous quantification of ODS and F-gases emissions in China and globally.
                </p>
                <p>
                    Their joint efforts have been instrumental in bridging the gap between "bottom-up" inventory methods and "top-down" atmospheric inversion models. This integrated approach has provided the Chinese government and international bodies like the WMO and UNEP with accurate data to assess the progress of HFCs phase-down and CFCs phase-out, contributing significantly to global climate mitigation and ozone layer recovery.
                </p>
            </div>
        </div>

<div class="mb-12">
    <h2 class="text-2xl font-bold text-center text-gray-900 mb-8">Core Members</h2>
    <div class="grid md:grid-cols-3 gap-8">
        
        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition duration-300">
            <div class="w-32 h-32 mx-auto mb-6 relative">
                <img src="fang.jpg" alt="Xuekun Fang" 
                     class="w-full h-full rounded-full object-cover border-4 border-blue-50 shadow-sm">
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-1">Xuekun Fang</h3>
            <p class="text-blue-600 font-medium mb-2">Zhejiang University</p>
            <div class="text-sm text-gray-500 space-y-1">
                <p class="text-blue-500 break-all font-mono">fangxuekun@zju.edu.cn</p>
            </div>
        </div>

        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition duration-300">
            <div class="w-32 h-32 mx-auto mb-6 relative">
                <img src="hu.jpg" alt="Jianxin Hu" 
                     class="w-full h-full rounded-full object-cover border-4 border-green-50 shadow-sm">
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-1">Jianxin Hu</h3>
            <p class="text-green-600 font-medium mb-2">Peking University</p>
            <div class="text-sm text-gray-500 space-y-1">
                <p class="text-blue-500 break-all font-mono">jianxin@pku.edu.cn</p>
            </div>
        </div>

        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center hover:shadow-md transition duration-300">
            <div class="w-32 h-32 mx-auto mb-6 relative">
                <img src="wu.jpg" alt="Jing Wu" 
                     class="w-full h-full rounded-full object-cover border-4 border-indigo-50 shadow-sm">
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-1">Jing Wu</h3>
            <p class="text-indigo-600 font-medium mb-2">Beijing Jiaotong University</p>
            <div class="text-sm text-gray-500 space-y-1">
                <p class="text-blue-500 break-all font-mono">wujing.108@bjtu.edu.cn</p>
            </div>
        </div>

    </div>
</div>

        <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-l-4 border-indigo-600 pl-4">Partner Institutions</h2>
            <div class="grid md:grid-cols-2 gap-8 text-sm text-gray-700">
                <div>
                    <h4 class="font-bold text-gray-900 mb-3 uppercase tracking-wide text-xs">Domestic Partners</h4>
                    <ul class="space-y-3">
                        <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>Chinese Research Academy of Environmental Sciences (CRAES)</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>Institute of Atmospheric Physics, CAS (IAP)</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>Chinese Academy of Environmental Planning (CAEP)</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>School of Environment, Tsinghua University</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>College of Environmental Sciences, Peking University</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-gray-900 mb-3 uppercase tracking-wide text-xs">International Partners</h4>
                    <ul class="space-y-3">
                        <li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>United Nations Environment Programme (UNEP)</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>World Meteorological Organization (WMO)</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>International Energy Agency (IEA)</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>U.S. Environmental Protection Agency (EPA)</li>
                        <li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-3"></span>European Commission Joint Research Centre (JRC)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white w-full max-w-md rounded-xl p-6">
                <h2 class="text-xl font-bold mb-4" id="auth-title">Login</h2>
                <div id="register-fields" class="space-y-2 hidden">
                    <input id="reg-name" class="w-full border p-2 rounded" placeholder="Full Name">
                    <input id="reg-country" class="w-full border p-2 rounded" placeholder="Country">
                </div>
                <input id="auth-email" class="w-full border p-2 rounded mt-2" placeholder="Email">
                <div class="flex justify-between mt-4">
                    <button onclick="submitAuth()" class="bg-blue-600 text-white px-4 py-2 rounded">Submit</button>
                    <button onclick="toggleAuthMode()" class="text-blue-600 text-sm">Switch to Register</button>
                </div>
                <button onclick="closeAuthModal()" class="text-gray-400 text-xs mt-3">Cancel</button>
            </div>
        </div>

    </main>

<footer class="bg-gray-900 text-gray-400 py-12 border-t border-gray-800">
        <div class="container mx-auto px-4 text-center">
            <p class="text-white mb-2">Ozone-depleting Substances & Fluorinated gases Emissions Database (OFED)</p>
            <p class="text-sm">If there are any omissions or errors, please inform us by email: <a href="mailto:contact@ofed.com" class="text-blue-400 underline">contact@ofed.com</a></p>
            <p class="mt-6 text-xs text-gray-600 tracking-widest uppercase italic">www.ofed.com</p>
        </div>
    </footer>

    <script>
    let inventoryData = [];
    let inversionData = [];
    let comparisonData = [];
    let isLoggedIn = false;
    let currentInvChartType = 'line';
    let authMode = 'login';

    const yearsRange = Array.from({length: 45}, (_, i) => 1980 + i);

    // 1. Data Loading
    async function loadData() {
        try {
            console.log("Starting to load CSV data...");
            const fetchCSV = async (url) => {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                const csvText = await response.text();
                return new Promise(resolve => {
                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => resolve(results.data)
                    });
                });
            };

            // Ensure these filenames match exactly what you upload to GitHub
            const [inv, invs, comp] = await Promise.all([
                fetchCSV('inventory.csv'),
                fetchCSV('inversion.csv'),
                fetchCSV('comparison.csv')
            ]);

            inventoryData = inv;
            inversionData = invs;
            comparisonData = comp;
            console.log("Data loaded successfully");
            return true;

        } catch (error) {
            console.error("Failed to load data:", error);
            document.body.insertAdjacentHTML('afterbegin', `<div class="bg-red-500 text-white p-4 text-center sticky top-0 z-[60]">Data loading failed: ${error.message}. Please check that inventory.csv, inversion.csv, and comparison.csv exist in the repository.</div>`);
            return false;
        }
    }

    // 2. Initialization
    window.addEventListener("load", async () => {
        // Initialize Dropdowns first
        initSelects();
        initInversionSelect();
        initComparisonSelect();

        // Load Data
        const success = await loadData();

        // If success, render charts
        if (success) {
            updateInventoryChart("line");
            renderInversionChart();
            renderComparisonChart();
        }

        // Show Home Page
        showPage("home");
    });

    window.onresize = function() {
        ['inventory-chart', 'inversion-chart', 'comparison-chart'].forEach(id => {
            const chart = echarts.getInstanceByDom(document.getElementById(id));
            if(chart) chart.resize();
        });
    };

    // 3. Navigation
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');

        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        if(pageId === 'home') document.getElementById('nav-home')?.classList.add('active');
        if(pageId === 'inventory') document.getElementById('nav-inventory')?.classList.add('active');
        if(pageId === 'inversion') document.getElementById('nav-inversion')?.classList.add('active');
        if(pageId === 'comparison') document.getElementById('nav-comparison')?.classList.add('active');
        if(pageId === 'about') document.getElementById('nav-about')?.classList.add('active');

        window.scrollTo(0, 0);

        // Re-render charts when tab switches to ensure correct width
        setTimeout(() => {
            if(pageId === 'inventory') updateInventoryChart(currentInvChartType);
            if(pageId === 'inversion') renderInversionChart();
            if(pageId === 'comparison') renderComparisonChart();
        }, 100);
    }

    // 4. Dropdown Initialization Helpers
    function initSelects() {
        const s = document.getElementById('start-year');
        const e = document.getElementById('end-year');
        fillYears(s, e);
    }
    function initInversionSelect() {
        const s = document.getElementById('inv-start-year');
        const e = document.getElementById('inv-end-year');
        fillYears(s, e);
    }
    function initComparisonSelect() {
        const s = document.getElementById('comp-start-year');
        const e = document.getElementById('comp-end-year');
        fillYears(s, e);
    }
    function fillYears(s, e) {
        if(!s || !e) return;
        s.innerHTML = ''; e.innerHTML = '';
        yearsRange.forEach(y => {
            s.add(new Option(y, y));
            e.add(new Option(y, y));
        });
        s.value = 1980;
        e.value = 2024;
    }

    // 5. Chart Logic - Inventory
// 1. 窗口大小自适应
window.addEventListener('resize', function() {
    const chartDom = document.getElementById('inventory-chart');
    const chart = echarts.getInstanceByDom(chartDom);
    if (chart) chart.resize();
});

function setActiveButton(activeId) {
    // 1. 找到所有的图表按钮
    const buttons = document.querySelectorAll('.chart-btn');
    
    buttons.forEach(btn => {
        if (btn.id === activeId) {
            // 2. 激活态：深蓝色背景，白色文字
            btn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
            btn.classList.add('bg-blue-900', 'text-white', 'hover:bg-black');
        } else {
            // 3. 非激活态：灰色背景，深灰色文字
            btn.classList.remove('bg-blue-900', 'text-white', 'hover:bg-black');
            btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
        }
    });
}


// 2. 主过滤器逻辑
function handleMainFilterChange() {
    const substance = document.getElementById('substance-select').value;
    const region = document.getElementById('region-select').value;
    
// 重置所有按钮颜色为灰色 (初始态)
    const buttons = document.querySelectorAll('.chart-btn');
    buttons.forEach(btn => {
        btn.classList.remove('bg-blue-900', 'text-white', 'hover:bg-black');
        btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
    });


    // 如果还没选好，清空下拉框和表格，不画图
    if (!substance || !region) {
        syncReferenceDropdown("", ""); 
        updatePublicationTable("", "");
        // 可选：清空图表
        const chartDom = document.getElementById('inventory-chart');
        let chart = echarts.getInstanceByDom(chartDom);
        if (chart) chart.clear(); 
        return;
    }

    syncReferenceDropdown(substance, region);
    updatePublicationTable(substance, region);
    
    // 选好后自动画图（默认折线图）
    updateInventoryChart('line');
}

// 3. 同步研究来源下拉框
function syncReferenceDropdown(substance, region) {
    const refSelect = document.getElementById('reference-select');
    
    // 过滤出当前物质和地区下的所有研究来源
    const sources = [...new Set(inventoryData
        .filter(d => d.substance === substance && d.region === region)
        .map(d => d.ref_short))];

    // 填充下拉框
    if (sources.length > 0) {
        refSelect.innerHTML = sources.map(s => `<option value="${s}">${s}</option>`).join('');
    } else {
        refSelect.innerHTML = '<option value="">No Sources</option>';
    }
}

// 4. 更新表格逻辑
function updatePublicationTable(substance, region) {
    const tableBody = document.getElementById('publication-table-body');
    const filteredData = inventoryData.filter(d => d.substance === substance && d.region === region);
    const uniqueShorts = [...new Set(filteredData.map(d => d.ref_short))];

    if (uniqueShorts.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">No references available.</td></tr>`;
        return;
    }

    tableBody.innerHTML = uniqueShorts.map(short => {
        const studyData = filteredData.filter(d => d.ref_short === short);
        const years = studyData.map(d => d.year);
        const yearRange = `${Math.min(...years)} - ${Math.max(...years)}`;
        const fullRef = studyData[0].ref_full || 'N/A';

        return `
            <tr class="hover:bg-gray-50 transition">
                <td class="p-4 font-bold text-blue-900">${short}</td>
                <td class="p-4">${substance}</td>
                <td class="p-4">${region}</td>
                <td class="p-4 text-gray-500">${yearRange}</td>
                <td class="p-4 italic text-gray-600">${fullRef}</td>
            </tr>
        `;
    }).join('');
}

// 5. 核心图表逻辑
function updateInventoryChart(type) {
    const substance = document.getElementById('substance-select').value;
    const region = document.getElementById('region-select').value;
    const sYear = parseInt(document.getElementById('start-year').value);
    const eYear = parseInt(document.getElementById('end-year').value);
    const selectedRefShort = document.getElementById('reference-select').value;

    const chartDom = document.getElementById('inventory-chart');
    let chart = echarts.getInstanceByDom(chartDom) || echarts.init(chartDom);
    chart.resize(); // 强制调整大小
    chart.clear();

    const yearRange = Array.from({length: eYear - sYear + 1}, (_, i) => sYear + i);
    let baseFiltered = inventoryData.filter(d => 
        d.substance === substance && d.region === region && d.year >= sYear && d.year <= eYear
    );

    let option = {
        title: { left: "center", top: 0, textStyle: { fontSize: 16 } },
        tooltip: { trigger: "axis", confine: true },
        legend: { bottom: 0, padding: [5, 10] },
        xAxis: { type: "category", data: yearRange },
        yAxis: { type: "value", name: "Gg yr⁻¹" },
        grid: { top: '60px', bottom: '60px', left: '50px', right: '20px', containLabel: true }
    };

    if (type === "line") {
        const sources = [...new Set(baseFiltered.map(d => d.ref_short))];
        option.title.text = `${substance} Emission Trends: ${region}`;
        option.series = sources.map(short => ({
            name: short,
            type: 'line',
            smooth: true,
            symbol: 'circle',
            symbolSize: 6,
            data: yearRange.map(y => {
                const row = baseFiltered.find(d => d.year === y && d.ref_short === short && d.sector.toLowerCase() === "total");
                return row ? row.value : null;
            })
        }));
    } else {
        // Bar Chart Logic
        if (!selectedRefShort) {
            // 如果没有选中的来源，给一个提示或不做处理
             chart.setOption({
                title: { text: "Please select a substance with valid sources", left: "center" }
            });
            return;
        }
        
        const refData = baseFiltered.filter(d => d.ref_short === selectedRefShort && d.sector.toLowerCase() !== "total");
        const sectors = [...new Set(refData.map(d => d.sector))];
        
        option.title.text = `${substance} Sectors (${selectedRefShort}) - ${region}`;
        option.series = sectors.map(sec => ({
            name: sec,
            type: "bar",
            stack: "total",
            data: yearRange.map(y => {
                const row = refData.find(d => d.year === y && d.sector === sec);
                return row ? row.value : null;
            })
        }));
    }
    chart.setOption(option);
}

// ==========================================
// 修复部分：页面初始化逻辑 (Fix)
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    // 1. 初始化年份下拉框 (保持不变)
    const startYearSelect = document.getElementById('start-year');
    const endYearSelect = document.getElementById('end-year');
    
    let yearOptions = '';
    for(let y = 1980; y <= 2024; y++) {
        yearOptions += `<option value="${y}">${y}</option>`;
    }
    startYearSelect.innerHTML = yearOptions;
    endYearSelect.innerHTML = yearOptions;
    
    startYearSelect.value = "1980";
    endYearSelect.value = "2024";

    // 2. 将物质和地区重置为初始状态 (即选中那个 "请选择" 选项)
    document.getElementById('substance-select').selectedIndex = 0;
    document.getElementById('region-select').selectedIndex = 0;
    
    // 3. 初始化下拉框和表格（此时由于没选物质，会显示 "No Sources"）
    handleMainFilterChange();

    // 4. 注意：这里不再调用 updateInventoryChart('line')
    // 只有当用户选择了具体数值后，通过 handleMainFilterChange 触发更新
});

    // 6. Chart Logic - Inversion
function renderInversionChart() {
    const chartDom = document.getElementById("inversion-chart");
    if (!chartDom) return;

    // 1. 获取当前筛选值
    const substance = document.getElementById("inv-substance").value;
    const region = document.getElementById("inv-country").value;
    const sYear = parseInt(document.getElementById("inv-start-year").value);
    const eYear = parseInt(document.getElementById("inv-end-year").value);

    // 校验年份逻辑
    if (sYear > eYear) {
        alert("Start year cannot be greater than end year");
        return;
    }

    // 初始化/获取图表实例
    let chart = echarts.getInstanceByDom(chartDom);
    if (chart) {
        chart.dispose();
    }
    chart = echarts.init(chartDom);

    // 2. 构造完整的横坐标年份数组
    // 确保这是一个连续的整数数组，使数据点落在刻度线上
    const yearRange = [];
    for (let y = sYear; y <= eYear; y++) {
        yearRange.push(y);
    }

    // 3. 过滤数据
    const filtered = inversionData.filter(d =>
        d.substance === substance &&
        d.region === region &&
        d.year >= sYear &&
        d.year <= eYear
    );

// ============= 新增：更新参考文献表格 =============
    updateReferenceTable(filtered);

    // 4. 检查是否有数据（无数据时显示提示）
    if (filtered.length === 0) {
        chart.setOption({
            title: { text: `${substance} Inversion Emissions (${region})`, left: "center" },
            graphic: {
                type: 'text',
                left: 'center',
                top: 'middle',
                style: { text: 'No Data Available', fill: '#999', font: 'bold 18px sans-serif' }
            },
            xAxis: { show: false },
            yAxis: { show: false },
            series: []
        });
        return;
    }

    const studies = [...new Set(filtered.map(d => d.study))];
    let series = [];
    let allValues = [0]; 

    // 5. 构造 Series
    studies.forEach(study => {
        const rows = filtered.filter(d => d.study === study);
        const lineData = [];
        const errorData = [];

        // 遍历 yearRange 确保每个年份索引对应正确
        yearRange.forEach((y, idx) => {
            const r = rows.find(d => d.year === y);
            
            // 如果该年份没有该研究的数据，存入 null 以保持坐标对齐且不连线
            if (!r) {
                lineData.push(null); 
                return;
            }

            const val = r.mean ?? r.Mean;
            const sd  = r.sd ?? r.SD ?? 0;

            if (val !== undefined && val !== null) {
                // 存入对象以便 formatter 调用
                lineData.push({
                    value: val,
                    sdValue: sd 
                });
                allValues.push(val);

                if (sd > 0) {
                    const low = val - sd;
                    const high = val + sd;
                    // 存储索引 idx 以确保误差棒精准对齐刻度
                    errorData.push([idx, low, high]);
                    allValues.push(high);
                }
            } else {
                lineData.push(null);
            }
        });

        // 折线系列配置
        series.push({
            name: study,
            type: "line",
            data: lineData,
            smooth: false,      // 需求1：直线连接
            symbol: "circle",
            symbolSize: 8,
            z: 20,
            connectNulls: false // 需求2：无数据不显示且断开连接
        });

        // 误差棒系列配置
        if (errorData.length > 0) {
            series.push({
                type: "custom",
                name: study,
                renderItem: function (params, api) {
                    const xIndex = api.value(0);
                    const low = api.coord([xIndex, api.value(1)]);
                    const high = api.coord([xIndex, api.value(2)]);
                    const half = 5; // 误差棒横线宽度
                    const style = api.style({
                        stroke: api.visual('color'),
                        lineWidth: 1.5
                    });
                    return {
                        type: 'group',
                        children: [
                            { type: 'line', shape: { x1: high[0], y1: high[1], x2: low[0], y2: low[1] }, style },
                            { type: 'line', shape: { x1: high[0]-half, y1: high[1], x2: high[0]+half, y2: high[1] }, style },
                            { type: 'line', shape: { x1: low[0]-half, y1: low[1], x2: low[0]+half, y2: low[1] }, style }
                        ]
                    };
                },
                data: errorData,
                z: 10,
                tooltip: { show: false }
            });
        }
    });

    // 计算 Y 轴动态范围
    const rawMax = Math.max(...allValues);
    const interval = Math.ceil((rawMax || 10) / 5 / 2) * 2; 
    const yMax = interval * 5;

    // 6. 设置图表最终 Option
    chart.setOption({
        title: { 
            text: `${substance} Inversion Emissions (${region})`, 
            left: "center",
            top: 10 
        },
        tooltip: { 
            trigger: "axis",
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            formatter: function(params) {
                let res = `<b>Year: ${params[0].name}</b><br/>`;
                let hasValidData = false;
                params.forEach(p => {
                    if (p.seriesType === 'line' && p.value !== null && p.value !== undefined) {
                        const val = typeof p.value === 'object' ? p.value.value : p.value;
                        const sd = p.data.sdValue !== undefined ? p.data.sdValue : 0;
                        res += `${p.marker} ${p.seriesName}: <b>${val}</b> (±${sd})<br/>`;
                        hasValidData = true;
                    }
                });
                return hasValidData ? res : null; // 如果整行无数据则不显示 Tooltip
            }
        },
        legend: { bottom: 5, data: studies },
        grid: { left: '5%', right: '5%', bottom: '15%', containLabel: true },
        xAxis: {
            type: "category",
            data: yearRange,
            // 关键修改：boundaryGap 设为 true 让点落在刻度中间，
            // 配合 axisTick 的 alignWithLabel 确保刻度线对准年份。
            boundaryGap: true, 
            axisTick: {
                alignWithLabel: true 
            },
            axisLabel: {
                interval: 0,
                rotate: yearRange.length > 12 ? 45 : 0 // 年份过多自动旋转
            }
        },
        yAxis: {
            type: "value",
            name: "Gg yr⁻¹",
            min: 0,
            max: yMax,
            interval: interval,
            splitLine: { lineStyle: { type: 'dashed' } },
            axisTick: { show: true },
            axisLine: { show: true }
        },
        series: series
    });
}

function updateReferenceTable(data) {
    const tableBody = document.getElementById("inversion-ref-table");
    const noDataMsg = document.getElementById("no-ref-msg");
    
    if (!tableBody) return;

    // 清空现有内容
    tableBody.innerHTML = "";

    if (data.length === 0) {
        noDataMsg.classList.remove("hidden");
        return;
    }
    noDataMsg.classList.add("hidden");

    // 为了避免表格过长，我们可以按 研究+年份 进行去重显示，或者显示所有涉及的条目
    // 这里采用：显示当前筛选范围内所有出现的独特研究及其引用
    const uniqueRefs = [];
    const seen = new Set();

    data.forEach(item => {
        // 创建一个唯一标识：研究+年份+物质+区域
        const key = `${item.study}-${item.year}-${item.substance}-${item.region}`;
        if (!seen.has(key)) {
            uniqueRefs.push(item);
            seen.add(key);
        }
    });

    // 排序：按年份降序，然后按研究缩写升序
    uniqueRefs.sort((a, b) => b.year - a.year || a.study.localeCompare(b.study));

    uniqueRefs.forEach(ref => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-blue-50 transition-colors";
        
        // 容错处理：如果 CSV 里没有 citation 列，显示为 "N/A"
        const citation = ref.citation || ref.Citation || "Reference not provided in CSV";

        tr.innerHTML = `
            <td class="px-4 py-3 font-semibold text-blue-900">${ref.study}</td>
            <td class="px-4 py-3">${ref.substance}</td>
            <td class="px-4 py-3">${ref.region}</td>
            <td class="px-4 py-3 text-gray-500">${ref.year}</td>
            <td class="px-4 py-3 italic text-gray-600">${citation}</td>
        `;
        tableBody.appendChild(tr);
    });
}

// 7. Chart Logic - Comparison
function renderComparisonChart() {
    const chartDom = document.getElementById("comparison-chart");
    if (!chartDom) return;

    // 1. 获取当前筛选值
    const substance = document.getElementById("comp-substance").value;
    const region = document.getElementById("comp-region").value;
    const sYear = parseInt(document.getElementById("comp-start-year").value);
    const eYear = parseInt(document.getElementById("comp-end-year").value);
    const methodFilter = document.getElementById("comp-method-filter").value;

    // 校验年份逻辑
    if (sYear > eYear) {
        alert("Start year cannot be greater than end year");
        return;
    }

    // 2. 构造完整的横坐标年份数组
    const yearRange = [];
    for (let y = sYear; y <= eYear; y++) {
        yearRange.push(y);
    }

    // 3. 初始化/获取图表实例
    let chart = echarts.getInstanceByDom(chartDom);
    if (chart) {
        chart.dispose();
    }
    chart = echarts.init(chartDom);

    // 4. 过滤基础数据
    let filtered = comparisonData.filter(d =>
        d.substance === substance &&
        d.region === region &&
        d.year >= sYear &&
        d.year <= eYear
    );

    // 方法学筛选
    if (methodFilter !== 'All') {
        filtered = filtered.filter(d => {
            const m = (d.method || "").toLowerCase();
            if (methodFilter === 'Bottom-up') return m.includes('bottom-up');
            if (methodFilter === 'Top-down') return m.includes('inverse') || m.includes('isc');
            return true;
        });
    }

    // 检查是否有数据
    if (filtered.length === 0) {
        chart.setOption({
            title: { text: `${substance} Emission Comparison (${region})`, left: "center" },
            graphic: {
                type: 'text', left: 'center', top: 'middle',
                style: { text: 'No Data Available', fill: '#999', font: 'bold 18px sans-serif' }
            },
            xAxis: { show: false }, yAxis: { show: false }, series: []
        });
        return;
    }

    const datasets = [...new Set(filtered.map(d => d.dataset))];
    let series = [];
    let tableHTML = "";
    let allValuesForScale = [0];

    // 5. 构造 Series 数据
    datasets.forEach(name => {
        const rows = filtered.filter(d => d.dataset === name);
        const lineData = [];
        const errorData = [];
        const method = rows[0]?.method || "Unknown";

        // 遍历完整的 yearRange
        yearRange.forEach((y, idx) => {
            const r = rows.find(d => d.year === y);
            if (!r) {
                lineData.push(null); // 该年无数据，Tooltip 将不会显示此研究
                return;
            }

            const val = r.value ?? r.mean ?? r.Mean;
            const sd = r.sd ?? r.SD ?? 0;

            if (val !== undefined && val !== null) {
                // 将 SD 存储在数据项中以便 Tooltip 调用
                lineData.push({
                    value: val,
                    sdValue: sd
                });
                allValuesForScale.push(val);

                // 记录误差棒数据
                if (sd > 0) {
                    const upper = val + sd;
                    const lower = val - sd;
                    errorData.push([idx, lower, upper]);
                    allValuesForScale.push(upper, lower);
                }
            } else {
                lineData.push(null);
            }
        });

        // 添加主折线
        series.push({
            name: name,
            type: "line",
            data: lineData,
            smooth: false,
            connectNulls: false, // 核心需求：缺失处不连线
            symbol: method.toLowerCase().includes("bottom-up") ? "circle" : "emptyTriangle",
            symbolSize: 8,
            z: 20
        });

        // 添加误差棒 (Custom Series)
        if (errorData.length > 0) {
            series.push({
                type: "custom",
                name: name,
                renderItem: function (params, api) {
                    const xIndex = api.value(0);
                    const low = api.coord([xIndex, api.value(1)]);
                    const high = api.coord([xIndex, api.value(2)]);
                    const half = 4;
                    const style = api.style({
                        stroke: api.visual('color'), lineWidth: 1.5, fill: null
                    });
                    return {
                        type: 'group',
                        children: [
                            { type: 'line', shape: { x1: high[0], y1: high[1], x2: low[0], y2: low[1] }, style },
                            { type: 'line', shape: { x1: high[0] - half, y1: high[1], x2: high[0] + half, y2: high[1] }, style },
                            { type: 'line', shape: { x1: low[0] - half, y1: low[1], x2: low[0] + half, y2: low[1] }, style }
                        ]
                    };
                },
                data: errorData,
                z: 10,
                tooltip: { show: false } // 隐藏误差棒自身的 tooltip，统一由 axis tooltip 处理
            });
        }

        tableHTML += `<tr><td class="px-6 py-4">${name}</td><td class="px-6 py-4">${method}</td><td class="px-6 py-4">${sYear}-${eYear}</td></tr>`;
    });

    // 动态 Y 轴计算
    const rawMax = Math.max(...allValuesForScale);
    const splitNumber = 5;
    let interval = Math.ceil((rawMax || 100) / splitNumber / 5) * 5;
    if (interval === 0) interval = 10;
    const yMax = interval * splitNumber;

    const tableBody = document.getElementById("comp-table-body");
    if (tableBody) tableBody.innerHTML = tableHTML;

    // 6. 配置图表
    chart.setOption({
        title: { 
            text: `${substance} Emission Comparison (${region})`, 
            left: "center",
            top: 10
        },
        tooltip: { 
            trigger: "axis",
            // 核心修改：自定义 Tooltip 内容
            formatter: function(params) {
                let res = `<b>Year: ${params[0].name}</b><br/>`;
                let hasValidData = false;

                params.forEach(p => {
                    // 只处理 line 类型的系列，且排除值为 null 的点
                    if (p.seriesType === 'line' && p.value !== null && p.value !== undefined) {
                        // 因为 data 改为了对象，所以取值方式为 p.value.value 或 p.data.value
                        const val = p.data.value !== undefined ? p.data.value : p.value;
                        const sd = p.data.sdValue !== undefined ? p.data.sdValue : "N/A";
                        
                        res += `${p.marker} ${p.seriesName}: <b>${val}</b> (±${sd})<br/>`;
                        hasValidData = true;
                    }
                });
                
                return hasValidData ? res : null;
            }
        },
        legend: { bottom: 5, data: datasets },
        grid: { left: '5%', right: '5%', bottom: '15%', containLabel: true },
        xAxis: { 
            type: "category", 
            data: yearRange,
            boundaryGap: true,
            axisTick: { alignWithLabel: true },
            axisLabel: {
                interval: 0,
                rotate: yearRange.length > 10 ? 45 : 0
            }
        },
        yAxis: { 
            type: "value", 
            name: "Gg yr⁻¹",
            min: 0,
            max: yMax,
            interval: interval,
            splitLine: { show: true, lineStyle: { type: 'dashed' } }
        },
        series: series
    });
}

    // 8. Auth & Downloads (Simulated)
    function openAuthModal() { document.getElementById('auth-modal').classList.remove('hidden'); }
    function closeAuthModal() { document.getElementById('auth-modal').classList.add('hidden'); }
    function toggleAuthMode() {
        authMode = authMode === 'login' ? 'register' : 'login';
        document.getElementById('register-fields').classList.toggle('hidden');
        document.getElementById('auth-title').innerText = authMode === 'login' ? 'Login' : 'Register';
    }

    function submitAuth() {
        // GitHub Pages Simulation: Just set true
        isLoggedIn = true;
        const email = document.getElementById('auth-email').value || "user@demo.com";
        document.getElementById('user-status').innerHTML = `<span class="text-sm font-semibold">Welcome, ${email}</span>`;
        closeAuthModal();
        alert("Login Successful (Demo Mode)");
    }

    function handleDownload(filename) {
        if (!isLoggedIn) {
            alert("Please login to download data.");
            openAuthModal();
            return;
        }
        // Direct download from GitHub Pages (static file)
        const link = document.createElement("a");
        link.href = filename; // Points to the file in the same folder
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    </script>
</body>
</html>